# -*- coding: utf-8 -*-
"""
ì‹œê°„í‘œ ì‘ì„± ë‹¤ì´ì–¼ë¡œê·¸
"""

from PyQt5.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout, QPushButton,
                             QLabel, QComboBox, QMessageBox, QGroupBox,
                             QTableWidget, QTableWidgetItem, QHeaderView,
                             QProgressBar, QFrame, QScrollArea, QDialog,
                             QDialogButtonBox, QFileDialog, QInputDialog)
from PyQt5.QtCore import Qt, QDate
from PyQt5.QtGui import QColor, QBrush, QFont
from datetime import datetime, timedelta, time
import random
import sys
import os

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from database.db_manager import DatabaseManager


class TimetableCreateDialog(QWidget):
    """ì‹œê°„í‘œ ì‘ì„± ìœ„ì ¯"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.db = DatabaseManager()
        self.selected_course = None
        self.subjects = []
        self.holidays = set()
        self.subject_colors = {}
        self.current_timetable = []  # í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ì‹œê°„í‘œ
        self.timetable_id = None  # ì €ì¥ëœ ì‹œê°„í‘œ ID
        self.init_ui()
        self.load_courses()
        
    def init_ui(self):
        """UI ì´ˆê¸°í™”"""
        layout = QVBoxLayout()
        layout.setSpacing(10)
        layout.setContentsMargins(10, 10, 10, 10)
        
        # ê³¼ì • ì„ íƒ
        course_group = QGroupBox("ğŸ“š ê³¼ì • ì„ íƒ")
        course_group.setStyleSheet("QGroupBox { font-size: 11pt; font-weight: bold; padding-top: 10px; }")
        course_layout = QHBoxLayout()
        
        self.course_combo = QComboBox()
        self.course_combo.setMinimumHeight(32)
        self.course_combo.setStyleSheet("font-size: 11pt;")
        self.course_combo.currentIndexChanged.connect(self.on_course_selected)
        course_layout.addWidget(self.course_combo)
        
        self.course_info_label = QLabel("ê³¼ì •ì„ ì„ íƒí•˜ì„¸ìš”")
        self.course_info_label.setStyleSheet("font-size: 11pt; color: #666;")
        course_layout.addWidget(self.course_info_label)
        course_layout.addStretch()
        
        course_group.setLayout(course_layout)
        layout.addWidget(course_group)
        
        # ê³¼ëª© ëª©ë¡
        subject_group = QGroupBox("ğŸ“‹ ê³¼ëª© ëª©ë¡")
        subject_group.setStyleSheet("QGroupBox { font-size: 11pt; font-weight: bold; padding-top: 10px; }")
        subject_layout = QVBoxLayout()
        
        self.subject_table = QTableWidget()
        self.subject_table.setColumnCount(7)
        self.subject_table.setHorizontalHeaderLabels([
            "ê³¼ëª©ëª…", "ì‹œìˆ˜", "ì¼ìˆ˜", "ì£¼ê°•ì‚¬", "ë³´ì¡°ê°•ì‚¬", "ì˜ˆë¹„ê°•ì‚¬", "ìƒ‰ìƒ"
        ])
        self.subject_table.horizontalHeader().setSectionResizeMode(0, QHeaderView.Stretch)
        # 6ê°œ í–‰ì´ ë³´ì´ë„ë¡ ë†’ì´ ì„¤ì • (í—¤ë” 30px + í–‰ 6ê°œ * 30px = 210px)
        self.subject_table.setFixedHeight(210)
        self.subject_table.setStyleSheet("font-size: 11pt;")
        subject_layout.addWidget(self.subject_table)
        
        subject_group.setLayout(subject_layout)
        layout.addWidget(subject_group)
        
        # ìë™ ë°°ì • ë²„íŠ¼
        btn_layout = QHBoxLayout()
        
        self.auto_btn = QPushButton("ğŸ¯ ìë™ ë°°ì •")
        self.auto_btn.setStyleSheet("background-color: #4CAF50; color: white; padding: 10px 20px; font-size: 11pt;")
        self.auto_btn.setMinimumHeight(40)
        self.auto_btn.clicked.connect(self.auto_assign)
        self.auto_btn.setEnabled(False)
        btn_layout.addWidget(self.auto_btn)
        
        self.save_btn = QPushButton("ğŸ’¾ ì €ì¥")
        self.save_btn.setStyleSheet("background-color: #2196F3; color: white; padding: 10px 20px; font-size: 11pt;")
        self.save_btn.setMinimumHeight(40)
        self.save_btn.clicked.connect(self.save_timetable)
        self.save_btn.setEnabled(False)
        btn_layout.addWidget(self.save_btn)
        
        self.export_btn = QPushButton("ğŸ“¥ Excel ë‹¤ìš´ë¡œë“œ")
        self.export_btn.setStyleSheet("padding: 10px 20px; font-size: 11pt;")
        self.export_btn.setMinimumHeight(40)
        self.export_btn.clicked.connect(self.export_excel)
        self.export_btn.setEnabled(False)
        btn_layout.addWidget(self.export_btn)
        
        self.import_btn = QPushButton("ğŸ“¤ Excel ì—…ë¡œë“œ")
        self.import_btn.setStyleSheet("padding: 10px 20px; font-size: 11pt;")
        self.import_btn.setMinimumHeight(40)
        self.import_btn.clicked.connect(self.import_excel)
        btn_layout.addWidget(self.import_btn)
        
        self.delete_btn = QPushButton("ğŸ—‘ï¸ ì‚­ì œ")
        self.delete_btn.setStyleSheet("background-color: #F44336; color: white; padding: 10px 20px; font-size: 11pt;")
        self.delete_btn.setMinimumHeight(40)
        self.delete_btn.clicked.connect(self.delete_timetable)
        self.delete_btn.setEnabled(False)
        btn_layout.addWidget(self.delete_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # ì§„í–‰ë¥  í‘œì‹œ
        self.progress = QProgressBar()
        self.progress.setStyleSheet("font-size: 11pt;")
        self.progress.setVisible(False)
        layout.addWidget(self.progress)
        
        # ì‹œê°„í‘œ í…Œì´ë¸”
        timetable_group = QGroupBox("ğŸ“… ìƒì„±ëœ ì‹œê°„í‘œ")
        timetable_group.setStyleSheet("QGroupBox { font-size: 11pt; font-weight: bold; padding-top: 10px; }")
        timetable_layout = QVBoxLayout()
        
        # ìŠ¤í¬ë¡¤ ì˜ì—­
        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        scroll.setMinimumHeight(400)
        
        self.timetable_table = QTableWidget()
        self.timetable_table.setColumnCount(8)
        self.timetable_table.setHorizontalHeaderLabels([
            "ì£¼ì°¨", "ë‚ ì§œ", "ì˜¤ì „(09:00-13:00)", "ì˜¤í›„(14:00-18:00)", "ì£¼ê°•ì‚¬", "ë³´ì¡°ê°•ì‚¬", "ì˜ˆë¹„ê°•ì‚¬", "ì§„í–‰ë„"
        ])
        self.timetable_table.horizontalHeader().setSectionResizeMode(0, QHeaderView.ResizeToContents)
        self.timetable_table.horizontalHeader().setSectionResizeMode(1, QHeaderView.ResizeToContents)
        self.timetable_table.horizontalHeader().setSectionResizeMode(2, QHeaderView.Stretch)
        self.timetable_table.horizontalHeader().setSectionResizeMode(3, QHeaderView.Stretch)
        self.timetable_table.setStyleSheet("font-size: 11pt;")
        self.timetable_table.cellClicked.connect(self.on_cell_clicked)
        
        scroll.setWidget(self.timetable_table)
        timetable_layout.addWidget(scroll)
        
        timetable_group.setLayout(timetable_layout)
        layout.addWidget(timetable_group)
        
        self.setLayout(layout)
    
    def load_courses(self):
        """ê³¼ì • ëª©ë¡ ë¡œë“œ"""
        try:
            if self.db.connect():
                query = "SELECT code, name, start_date FROM courses ORDER BY start_date DESC"
                courses = self.db.fetch_all(query)
                
                self.course_combo.clear()
                self.course_combo.addItem("-- ê³¼ì • ì„ íƒ --", None)
                
                for course in courses:
                    display_text = f"{course['code']} - {course['name']}"
                    if course.get('start_date'):
                        display_text += f" ({course['start_date'].strftime('%Y-%m-%d')})"
                    self.course_combo.addItem(display_text, course['code'])
                    
        except Exception as e:
            QMessageBox.critical(self, "ì˜¤ë¥˜", f"ê³¼ì • ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: {str(e)}")
    
    def on_course_selected(self, index):
        """ê³¼ì • ì„ íƒ ì‹œ"""
        if index <= 0:
            self.selected_course = None
            self.auto_btn.setEnabled(False)
            self.course_info_label.setText("ê³¼ì •ì„ ì„ íƒí•˜ì„¸ìš”")
            return
        
        course_code = self.course_combo.itemData(index)
        self.selected_course = course_code
        self.load_course_info()
        self.load_subjects()
        self.load_holidays()
        self.auto_btn.setEnabled(True)
    
    def load_course_info(self):
        """ê³¼ì • ì •ë³´ ë¡œë“œ"""
        try:
            query = """
                SELECT start_date, lecture_end_date, lecture_hours 
                FROM courses 
                WHERE code = %s
            """
            result = self.db.fetch_one(query, (self.selected_course,))
            
            if result:
                info = f"ì‹œì‘: {result['start_date'].strftime('%Y-%m-%d')}"
                if result.get('lecture_end_date'):
                    info += f" ~ {result['lecture_end_date'].strftime('%Y-%m-%d')}"
                info += f" | ì´ {result['lecture_hours']}ì‹œê°„"
                self.course_info_label.setText(info)
                
        except Exception as e:
            print(f"ê³¼ì • ì •ë³´ ë¡œë“œ ì˜¤ë¥˜: {str(e)}")
    
    def load_subjects(self):
        """ê³¼ëª© ëª©ë¡ ë¡œë“œ"""
        try:
            query = """
                SELECT s.code, s.name, s.hours, 
                       i1.name as main_instructor_name,
                       i2.name as assistant_instructor_name,
                       i3.name as reserve_instructor_name
                FROM subjects s
                LEFT JOIN instructors i1 ON s.main_instructor = i1.code
                LEFT JOIN instructors i2 ON s.assistant_instructor = i2.code
                LEFT JOIN instructors i3 ON s.reserve_instructor = i3.code
                ORDER BY s.hours ASC
            """
            self.subjects = self.db.fetch_all(query)
            
            self.subject_table.setRowCount(len(self.subjects))
            
            # ê³¼ëª©ë³„ ìƒ‰ìƒ ìƒì„±
            self.subject_colors = {}
            colors = self.generate_colors(len(self.subjects))
            
            for i, subject in enumerate(self.subjects):
                # ê³¼ëª©ëª…
                self.subject_table.setItem(i, 0, QTableWidgetItem(subject['name']))
                
                # ì‹œìˆ˜
                hours = subject['hours']
                self.subject_table.setItem(i, 1, QTableWidgetItem(f"{hours}ì‹œê°„"))
                
                # ì¼ìˆ˜ (1ì¼ 8ì‹œê°„ ê¸°ì¤€, ì†Œìˆ˜ì  1ìë¦¬)
                days = hours / 8.0
                self.subject_table.setItem(i, 2, QTableWidgetItem(f"{days:.1f}ì¼"))
                
                # ì£¼ê°•ì‚¬
                main_instructor = subject.get('main_instructor_name') or '-'
                self.subject_table.setItem(i, 3, QTableWidgetItem(main_instructor))
                
                # ë³´ì¡°ê°•ì‚¬
                assistant_instructor = subject.get('assistant_instructor_name') or '-'
                self.subject_table.setItem(i, 4, QTableWidgetItem(assistant_instructor))
                
                # ì˜ˆë¹„ê°•ì‚¬
                reserve_instructor = subject.get('reserve_instructor_name') or '-'
                self.subject_table.setItem(i, 5, QTableWidgetItem(reserve_instructor))
                
                # ìƒ‰ìƒ (íŒŒìŠ¤í…” í†¤)
                color = colors[i]
                self.subject_colors[subject['code']] = color
                color_item = QTableWidgetItem()
                color_item.setBackground(QBrush(color))
                self.subject_table.setItem(i, 6, color_item)
                
        except Exception as e:
            QMessageBox.critical(self, "ì˜¤ë¥˜", f"ê³¼ëª© ë¡œë“œ ì‹¤íŒ¨: {str(e)}")
    
    def load_holidays(self):
        """ê³µíœ´ì¼ ë¡œë“œ"""
        try:
            query = "SELECT holiday_date FROM holidays"
            rows = self.db.fetch_all(query)
            self.holidays = set([row['holiday_date'] for row in rows])
        except Exception as e:
            print(f"ê³µíœ´ì¼ ë¡œë“œ ì˜¤ë¥˜: {str(e)}")
    
    def generate_colors(self, count):
        """ê³¼ëª©ë³„ ê³ ìœ  íŒŒìŠ¤í…” ìƒ‰ìƒ ìƒì„±"""
        colors = []
        hue_step = 360 / count
        
        for i in range(count):
            hue = int(i * hue_step)
            # íŒŒìŠ¤í…” ìƒ‰ìƒ (ì±„ë„ 40%, ë°ê¸° 95%)
            color = QColor.fromHsv(hue, int(255 * 0.4), int(255 * 0.95))
            colors.append(color)
        
        return colors
    
    def auto_assign(self):
        """ìë™ ì‹œê°„í‘œ ë°°ì •"""
        if not self.selected_course or not self.subjects:
            QMessageBox.warning(self, "ê²½ê³ ", "ê³¼ì •ê³¼ ê³¼ëª©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.")
            return
        
        try:
            self.progress.setVisible(True)
            self.progress.setValue(0)
            
            # ê³¼ì • ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            query = "SELECT start_date, lecture_end_date FROM courses WHERE code = %s"
            course = self.db.fetch_one(query, (self.selected_course,))
            
            if not course or not course.get('start_date'):
                QMessageBox.warning(self, "ê²½ê³ ", "ê³¼ì • ì‹œì‘ì¼ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                return
            
            start_date = course['start_date']
            end_date = course.get('lecture_end_date') or start_date + timedelta(days=100)
            
            # ì‹œê°„í‘œ ìƒì„±
            self.current_timetable = self.create_timetable(start_date, end_date)
            
            # í…Œì´ë¸”ì— í‘œì‹œ
            self.display_timetable(self.current_timetable)
            
            self.progress.setValue(100)
            self.progress.setVisible(False)
            
            self.save_btn.setEnabled(True)
            self.export_btn.setEnabled(True)
            
            QMessageBox.information(self, "ì™„ë£Œ", "ì‹œê°„í‘œê°€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
            
        except Exception as e:
            self.progress.setVisible(False)
            QMessageBox.critical(self, "ì˜¤ë¥˜", f"ì‹œê°„í‘œ ìƒì„± ì‹¤íŒ¨: {str(e)}")
    
    def _make_subject_entry(self, subject, hours):
        """ê³¼ëª© ì—”íŠ¸ë¦¬ ìƒì„± í—¬í¼"""
        return {
            'code': subject['code'],
            'name': subject['name'],
            'total_hours': subject['hours'],
            'main_instructor': subject.get('main_instructor_name', '-'),
            'assistant_instructor': subject.get('assistant_instructor_name', '-'),
            'reserve_instructor': subject.get('reserve_instructor_name', '-'),
            'hours': hours
        }
    
    def _find_most_remaining(self, remaining):
        """ê°€ì¥ ì‹œìˆ˜ ë§ì´ ë‚¨ì€ ê³¼ëª© ì°¾ê¸°"""
        max_h = 0
        best = None
        for s in self.subjects:
            h = remaining.get(s['code'], 0)
            if h > max_h:
                max_h = h
                best = s
        return best
    
    def create_timetable(self, start_date, end_date):
        """ì‹œê°„í‘œ ìƒì„± ì•Œê³ ë¦¬ì¦˜ - ê°„ë‹¨ ëª…í™• ë²„ì „
        
        ê·œì¹™:
        1. 1ì¼ 1ê³¼ëª© (ì˜¤ì „ 4h + ì˜¤í›„ 4h = í•˜ë£¨ 8h)
        2. ë‹¤ìŒë‚ ì€ ë‹¤ë¥¸ ê³¼ëª©
        3. ê¸ˆìš”ì¼ì€ ì‹œìˆ˜ ì ì€ 2ê°œ ê³¼ëª© ê²©ì£¼
        4. ì˜¤ì „ ì™„ë£Œ ì‹œ â†’ ì˜¤í›„ëŠ” ê°€ì¥ ì‹œìˆ˜ ë§ì´ ë‚¨ì€ ê³¼ëª©
        5. ê¸ˆìš”ì¼ ê³¼ëª©ë„ ë¹ˆ ìë¦¬ ê°€ëŠ¥
        """
        timetable = []
        
        # ë‚¨ì€ ì‹œìˆ˜
        remaining = {s['code']: s['hours'] for s in self.subjects}
        
        # ì‹œìˆ˜ê°€ ì ì€ ê³¼ëª© 2ê°œ (ê¸ˆìš”ì¼ ê²©ì£¼ ë°°ì •ìš©)
        sorted_subjects = sorted(self.subjects, key=lambda x: x['hours'])
        friday_subjects = [sorted_subjects[0]['code'], sorted_subjects[1]['code']] if len(sorted_subjects) >= 2 else []
        friday_week = 0
        
        current_date = start_date
        current_subject_index = 2 if len(sorted_subjects) > 2 else 0  # ê¸ˆìš”ì¼ ê³¼ëª© ì œì™¸
        carry_over_subject = None  # ì˜¤ì „ì— ëë‚œ ê³¼ëª© ë‹¤ìŒì— ì˜¬ ê³¼ëª©
        
        while current_date <= end_date and any(h > 0 for h in subject_remaining.values()):
            # ì£¼ë§ ì œì™¸
            if current_date.weekday() >= 5:
                current_date += timedelta(days=1)
                continue
            
            # ê³µíœ´ì¼ ì œì™¸
            if current_date in self.holidays:
                current_date += timedelta(days=1)
                continue
            
            am_subject = None
            pm_subject = None
            
            # carry_overê°€ ìˆìœ¼ë©´ ì˜¤ì „ì— ì‚¬ìš©
            if carry_over_subject:
                # ì˜¤ì „ì— ì´ì›”ëœ ê³¼ëª© ì‹œì‘
                subject = carry_over_subject
                subject_code = subject['code']
                remaining = subject_remaining[subject_code]
                
                am_hours = min(4, remaining)
                am_subject = {
                    'code': subject_code,
                    'name': subject['name'],
                    'total_hours': subject['hours'],
                    'main_instructor': subject.get('main_instructor_name') or '-',
                    'assistant_instructor': subject.get('assistant_instructor_name') or '-',
                    'reserve_instructor': subject.get('reserve_instructor_name') or '-',
                    'hours': am_hours
                }
                subject_remaining[subject_code] -= am_hours
                
                # ì˜¤í›„ ì²˜ë¦¬
                if subject_remaining[subject_code] >= 4:
                    # ì•„ì§ 4ì‹œê°„ ì´ìƒ ë‚¨ìŒ - ì˜¤í›„ì—ë„ ê°™ì€ ê³¼ëª©
                    pm_subject = am_subject.copy()
                    pm_subject['hours'] = 4
                    subject_remaining[subject_code] -= 4
                    carry_over_subject = None  # ë‹¤ìŒë‚ ì€ ìƒˆ ê³¼ëª©
                else:
                    # 4ì‹œê°„ ë¯¸ë§Œ ë‚¨ìŒ ë˜ëŠ” ì™„ë£Œ - ì˜¤í›„ì— ê°€ì¥ ì‹œìˆ˜ê°€ ë§ì´ ë‚¨ì€ ê³¼ëª©
                    carry_over_subject = None
                    current_subject_index += 1
                    
                    # ê°€ì¥ ì‹œìˆ˜ê°€ ë§ì´ ë‚¨ì€ ê³¼ëª© ì°¾ê¸°
                    max_remaining = 0
                    next_subj = None
                    
                    for subj in self.subjects:
                        remaining = subject_remaining.get(subj['code'], 0)
                        if remaining > max_remaining:
                            max_remaining = remaining
                            next_subj = subj
                    
                    if next_subj and max_remaining > 0:
                        next_code = next_subj['code']
                        
                        if subject_remaining.get(next_code, 0) > 0:
                            pm_subject = {
                                'code': next_code,
                                'name': next_subj['name'],
                                'total_hours': next_subj['hours'],
                                'main_instructor': next_subj.get('main_instructor_name') or '-',
                                'assistant_instructor': next_subj.get('assistant_instructor_name') or '-',
                                'reserve_instructor': next_subj.get('reserve_instructor_name') or '-',
                                'hours': 4
                            }
                            subject_remaining[next_code] -= 4
                            
                            # ì´ ê³¼ëª©ì„ ë‹¤ìŒë‚  ì˜¤ì „ì— ê³„ì† ì‚¬ìš©
                            carry_over_subject = next_subj
                            # ì¸ë±ìŠ¤ë„ ì—…ë°ì´íŠ¸
                            current_subject_index = sorted_subjects.index(next_subj) + 1
            
            # ê¸ˆìš”ì¼ íŠ¹ë³„ ì²˜ë¦¬ (ê¸ˆìš”ì¼ ê³¼ëª©ì´ ë‚¨ì•„ìˆì„ ë•Œë§Œ)
            elif current_date.weekday() == 4 and friday_subjects and any(subject_remaining.get(code, 0) > 0 for code in friday_subjects):
                # ê¸ˆìš”ì¼ ê³¼ëª© ì¤‘ ë‚¨ì€ ì‹œìˆ˜ê°€ ìˆëŠ” ê²ƒ ì°¾ê¸°
                friday_subject_code = None
                for _ in range(len(friday_subjects)):
                    test_code = friday_subjects[friday_week % len(friday_subjects)]
                    friday_week += 1
                    if subject_remaining.get(test_code, 0) > 0:
                        friday_subject_code = test_code
                        break
                
                # ê¸ˆìš”ì¼ ê³¼ëª©ì´ ë‚¨ì•„ìˆìœ¼ë©´ ìš°ì„  ë°°ì •
                if friday_subject_code:
                    subject_code = friday_subject_code
                # ê¸ˆìš”ì¼ ê³¼ëª©ì´ ëª¨ë‘ ì™„ë£Œë˜ë©´ í‰ì¼ ê³¼ëª© ë°°ì •
                else:
                    # ê°€ì¥ ì‹œìˆ˜ê°€ ë§ì´ ë‚¨ì€ ê³¼ëª© ì°¾ê¸°
                    max_remaining = 0
                    subject_code = None
                    for subj in self.subjects:
                        remaining = subject_remaining.get(subj['code'], 0)
                        if remaining > max_remaining:
                            max_remaining = remaining
                            subject_code = subj['code']
                
                if subject_code and subject_remaining.get(subject_code, 0) > 0:
                    subject = next((s for s in self.subjects if s['code'] == subject_code), None)
                    if subject:
                        remaining = subject_remaining[subject_code]
                        
                        # ì˜¤ì „ ë°°ì •
                        am_hours = min(4, remaining)
                        am_subject = {
                            'code': subject_code,
                            'name': subject['name'],
                            'total_hours': subject['hours'],
                            'main_instructor': subject.get('main_instructor_name') or '-',
                            'assistant_instructor': subject.get('assistant_instructor_name') or '-',
                            'reserve_instructor': subject.get('reserve_instructor_name') or '-',
                            'hours': am_hours
                        }
                        subject_remaining[subject_code] -= am_hours
                        
                        # ì˜¤í›„ ì²˜ë¦¬
                        if subject_remaining[subject_code] >= 4:
                            # ì˜¤í›„ì—ë„ ê°™ì€ ê³¼ëª© (1ì¼ 1ê³¼ëª© ì›ì¹™)
                            pm_subject = am_subject.copy()
                            pm_subject['hours'] = 4
                            subject_remaining[subject_code] -= 4
                        elif subject_remaining[subject_code] > 0:
                            # 4ì‹œê°„ ë¯¸ë§Œ ë‚¨ìŒ - ì˜¤í›„ì—ë„ ê°™ì€ ê³¼ëª© (ë‚¨ì€ ì‹œìˆ˜ë§Œí¼)
                            pm_subject = am_subject.copy()
                            pm_subject['hours'] = subject_remaining[subject_code]
                            subject_remaining[subject_code] = 0
                        else:
                            # ì˜¤ì „ì— ì™„ë£Œ - ì˜¤í›„ì— ë‹¤ìŒ ê³¼ëª© ì‹œì‘
                            # ë‹¤ìŒ ê³¼ëª© ì°¾ê¸° (ê¸ˆìš”ì¼ ê³¼ëª© ì œì™¸)
                            attempts = 0
                            while attempts < len(self.subjects):
                                if current_subject_index >= len(sorted_subjects):
                                    current_subject_index = 0
                                
                                next_subj = sorted_subjects[current_subject_index]
                                next_code = next_subj['code']
                                
                                if next_code in friday_subjects:
                                    current_subject_index += 1
                                    attempts += 1
                                    continue
                                
                                if subject_remaining.get(next_code, 0) > 0:
                                    pm_subject = {
                                        'code': next_code,
                                        'name': next_subj['name'],
                                        'total_hours': next_subj['hours'],
                                        'main_instructor': next_subj.get('main_instructor_name') or '-',
                                        'assistant_instructor': next_subj.get('assistant_instructor_name') or '-',
                                        'reserve_instructor': next_subj.get('reserve_instructor_name') or '-',
                                        'hours': 4
                                    }
                                    subject_remaining[next_code] -= 4
                                    break
                                
                                current_subject_index += 1
                                attempts += 1
            
            # ì¼ë°˜ í‰ì¼ - 1ì¼ 1ê³¼ëª© ì›ì¹™
            else:
                # í˜„ì¬ ê³¼ëª© ì°¾ê¸° (ê¸ˆìš”ì¼ ê³¼ëª©ë„ í¬í•¨)
                attempts = 0
                while attempts < len(self.subjects):
                    if current_subject_index >= len(sorted_subjects):
                        current_subject_index = 0
                    
                    subject = sorted_subjects[current_subject_index]
                    subject_code = subject['code']
                    remaining = subject_remaining.get(subject_code, 0)
                    
                    if remaining > 0:
                        # ì˜¤ì „ ë°°ì •
                        am_hours = min(4, remaining)
                        am_subject = {
                            'code': subject_code,
                            'name': subject['name'],
                            'total_hours': subject['hours'],
                            'main_instructor': subject.get('main_instructor_name') or '-',
                            'assistant_instructor': subject.get('assistant_instructor_name') or '-',
                            'reserve_instructor': subject.get('reserve_instructor_name') or '-',
                            'hours': am_hours
                        }
                        subject_remaining[subject_code] -= am_hours
                        
                        # ì˜¤í›„ ì²˜ë¦¬
                        if subject_remaining[subject_code] >= 4:
                            # ì˜¤í›„ì—ë„ ê°™ì€ ê³¼ëª© (1ì¼ 1ê³¼ëª© ì›ì¹™)
                            pm_subject = am_subject.copy()
                            pm_subject['hours'] = 4
                            subject_remaining[subject_code] -= 4
                            # ë‹¤ìŒë‚ ì€ ë‹¤ë¥¸ ê³¼ëª©
                            current_subject_index += 1
                        elif subject_remaining[subject_code] > 0:
                            # 4ì‹œê°„ ë¯¸ë§Œ ë‚¨ìŒ - ì˜¤í›„ì—ë„ ê°™ì€ ê³¼ëª©
                            pm_subject = am_subject.copy()
                            pm_subject['hours'] = subject_remaining[subject_code]
                            subject_remaining[subject_code] = 0
                            # ë‹¤ìŒë‚ ì€ ë‹¤ë¥¸ ê³¼ëª©
                            current_subject_index += 1
                        else:
                            # ì˜¤ì „ì— ì™„ë£Œ - ì˜¤í›„ì— ê°€ì¥ ì‹œìˆ˜ê°€ ë§ì´ ë‚¨ì€ ê³¼ëª© ë°°ì •
                            current_subject_index += 1
                            
                            # ê°€ì¥ ì‹œìˆ˜ê°€ ë§ì´ ë‚¨ì€ ê³¼ëª© ì°¾ê¸° (ê¸ˆìš”ì¼ ê³¼ëª© í¬í•¨)
                            max_remaining = 0
                            next_subj = None
                            
                            for subj in self.subjects:
                                remaining = subject_remaining.get(subj['code'], 0)
                                if remaining > max_remaining:
                                    max_remaining = remaining
                                    next_subj = subj
                            
                            if next_subj and max_remaining > 0:
                                next_code = next_subj['code']
                                pm_subject = {
                                    'code': next_code,
                                    'name': next_subj['name'],
                                    'total_hours': next_subj['hours'],
                                    'main_instructor': next_subj.get('main_instructor_name') or '-',
                                    'assistant_instructor': next_subj.get('assistant_instructor_name') or '-',
                                    'reserve_instructor': next_subj.get('reserve_instructor_name') or '-',
                                    'hours': 4
                                }
                                subject_remaining[next_code] -= 4
                                
                                # ì´ ê³¼ëª©ì„ ë‹¤ìŒë‚  ì˜¤ì „ì— ê³„ì† ì‚¬ìš©
                                carry_over_subject = next_subj
                                # ì¸ë±ìŠ¤ë„ ì—…ë°ì´íŠ¸
                                current_subject_index = sorted_subjects.index(next_subj) + 1
                        
                        break
                    
                    current_subject_index += 1
                    attempts += 1
            
            # í•˜ë£¨ ì‹œê°„í‘œ ì¶”ê°€
            if am_subject and pm_subject:
                timetable.append({
                    'date': current_date,
                    'am_subject': am_subject,
                    'pm_subject': pm_subject
                })
            
            current_date += timedelta(days=1)
        
        return timetable
    
    def display_timetable(self, timetable):
        """ì‹œê°„í‘œ í…Œì´ë¸”ì— í‘œì‹œ"""
        self.timetable_table.setRowCount(len(timetable))
        
        # ê³¼ëª©ë³„ ëˆ„ì  ì‹œìˆ˜ ê³„ì‚°
        subject_accumulated = {}
        
        # ì‹œì‘ì¼ ê¸°ì¤€ìœ¼ë¡œ ì£¼ì°¨ ê³„ì‚°
        if timetable:
            start_date = timetable[0]['date']
        
        previous_week = None
        
        for i, entry in enumerate(timetable):
            am_subject = entry.get('am_subject', {})
            pm_subject = entry.get('pm_subject', {})
            
            # ëˆ„ì  ì‹œìˆ˜ ê³„ì‚° (ì˜¤ì „)
            if am_subject:
                am_code = am_subject['code']
                if am_code not in subject_accumulated:
                    subject_accumulated[am_code] = 0
                subject_accumulated[am_code] += am_subject['hours']
            
            # ëˆ„ì  ì‹œìˆ˜ ê³„ì‚° (ì˜¤í›„)
            if pm_subject:
                pm_code = pm_subject['code']
                if pm_code not in subject_accumulated:
                    subject_accumulated[pm_code] = 0
                subject_accumulated[pm_code] += pm_subject['hours']
            
            # ì£¼ì°¨ ê³„ì‚° (ì‹œì‘ì¼ ê¸°ì¤€)
            current_date = entry['date']
            days_diff = (current_date - start_date).days
            week_number = (days_diff // 7) + 1
            
            # ì£¼ì°¨ í‘œì‹œ
            week_item = QTableWidgetItem(f"{week_number}ì£¼ì°¨")
            week_item.setTextAlignment(Qt.AlignCenter)
            
            # ì£¼ì°¨ê°€ ë°”ë€” ë•Œ ë°°ê²½ìƒ‰ ë³€ê²½ìœ¼ë¡œ êµ¬ë¶„
            if previous_week is not None and week_number != previous_week:
                # ìƒˆë¡œìš´ ì£¼ì°¨ì˜ ì²« ë²ˆì§¸ í–‰ ì „ì²´ì— ì—°í•œ íšŒìƒ‰ ë°°ê²½
                week_separator_color = QColor(200, 200, 200)
                week_item.setBackground(QBrush(week_separator_color))
                week_item.setFont(QFont("ë§‘ì€ ê³ ë”•", 11, QFont.Bold))
            else:
                # ê°™ì€ ì£¼ì°¨ ë‚´ì—ì„œëŠ” ë” ì—°í•œ ë°°ê²½
                week_item.setBackground(QBrush(QColor(245, 245, 245)))
            
            self.timetable_table.setItem(i, 0, week_item)
            previous_week = week_number
            
            # ë‚ ì§œ
            date_str = entry['date'].strftime("%Y-%m-%d (%a)")
            date_item = QTableWidgetItem(date_str)
            date_item.setData(Qt.UserRole, entry)  # ë°ì´í„° ì €ì¥
            self.timetable_table.setItem(i, 1, date_item)
            
            # ì˜¤ì „ ê³¼ëª© í‘œì‹œ
            if am_subject:
                am_code = am_subject['code']
                am_name = am_subject['name']
                am_total = am_subject['total_hours']
                am_accumulated = subject_accumulated.get(am_code, 0)
                
                # ê³¼ëª©ëª… ì¶•ì•½
                if len(am_name) > 10:
                    am_short = am_name[:10] + "..."
                else:
                    am_short = am_name
                
                am_text = f"{am_short}({am_accumulated}h/{am_total}h)"
                am_item = QTableWidgetItem(am_text)
                am_item.setToolTip(f"{am_name}\nì§„í–‰: {am_accumulated}h / {am_total}h")
                am_color = self.subject_colors.get(am_code, QColor(200, 200, 200))
                am_item.setBackground(QBrush(am_color))
                am_item.setTextAlignment(Qt.AlignCenter)
                self.timetable_table.setItem(i, 2, am_item)
            else:
                self.timetable_table.setItem(i, 2, QTableWidgetItem("-"))
            
            # ì˜¤í›„ ê³¼ëª© í‘œì‹œ
            if pm_subject:
                pm_code = pm_subject['code']
                pm_name = pm_subject['name']
                pm_total = pm_subject['total_hours']
                pm_accumulated = subject_accumulated.get(pm_code, 0)
                
                # ê³¼ëª©ëª… ì¶•ì•½
                if len(pm_name) > 10:
                    pm_short = pm_name[:10] + "..."
                else:
                    pm_short = pm_name
                
                pm_text = f"{pm_short}({pm_accumulated}h/{pm_total}h)"
                pm_item = QTableWidgetItem(pm_text)
                pm_item.setToolTip(f"{pm_name}\nì§„í–‰: {pm_accumulated}h / {pm_total}h")
                pm_color = self.subject_colors.get(pm_code, QColor(200, 200, 200))
                pm_item.setBackground(QBrush(pm_color))
                pm_item.setTextAlignment(Qt.AlignCenter)
                self.timetable_table.setItem(i, 3, pm_item)
            else:
                self.timetable_table.setItem(i, 3, QTableWidgetItem("-"))
            
            # ì£¼ê°•ì‚¬ (ì˜¤ì „ ê³¼ëª© ê¸°ì¤€, ì˜¤ì „/ì˜¤í›„ ë‹¤ë¥´ë©´ ë‘˜ ë‹¤ í‘œì‹œ)
            if am_subject and pm_subject:
                if am_subject['code'] == pm_subject['code']:
                    instructor_text = am_subject.get('main_instructor', '-')
                else:
                    instructor_text = f"{am_subject.get('main_instructor', '-')} / {pm_subject.get('main_instructor', '-')}"
            elif am_subject:
                instructor_text = am_subject.get('main_instructor', '-')
            elif pm_subject:
                instructor_text = pm_subject.get('main_instructor', '-')
            else:
                instructor_text = '-'
            
            main_instructor_item = QTableWidgetItem(instructor_text)
            main_instructor_item.setTextAlignment(Qt.AlignCenter)
            self.timetable_table.setItem(i, 4, main_instructor_item)
            
            # ë³´ì¡°ê°•ì‚¬
            if am_subject and pm_subject:
                if am_subject['code'] == pm_subject['code']:
                    assist_text = am_subject.get('assistant_instructor', '-')
                else:
                    assist_text = f"{am_subject.get('assistant_instructor', '-')} / {pm_subject.get('assistant_instructor', '-')}"
            elif am_subject:
                assist_text = am_subject.get('assistant_instructor', '-')
            elif pm_subject:
                assist_text = pm_subject.get('assistant_instructor', '-')
            else:
                assist_text = '-'
            
            assistant_instructor_item = QTableWidgetItem(assist_text)
            assistant_instructor_item.setTextAlignment(Qt.AlignCenter)
            self.timetable_table.setItem(i, 5, assistant_instructor_item)
            
            # ì˜ˆë¹„ê°•ì‚¬
            if am_subject and pm_subject:
                if am_subject['code'] == pm_subject['code']:
                    reserve_text = am_subject.get('reserve_instructor', '-')
                else:
                    reserve_text = f"{am_subject.get('reserve_instructor', '-')} / {pm_subject.get('reserve_instructor', '-')}"
            elif am_subject:
                reserve_text = am_subject.get('reserve_instructor', '-')
            elif pm_subject:
                reserve_text = pm_subject.get('reserve_instructor', '-')
            else:
                reserve_text = '-'
            
            reserve_instructor_item = QTableWidgetItem(reserve_text)
            reserve_instructor_item.setTextAlignment(Qt.AlignCenter)
            self.timetable_table.setItem(i, 6, reserve_instructor_item)
            
            # ì§„í–‰ë„ í‘œì‹œ (ì˜¤ì „ ê³¼ëª© ê¸°ì¤€)
            if am_subject:
                am_code = am_subject['code']
                am_total = am_subject['total_hours']
                am_accumulated = subject_accumulated.get(am_code, 0)
                progress_percent = (am_accumulated / am_total * 100) if am_total > 0 else 0
            else:
                progress_percent = 0
            
            progress_item = QTableWidgetItem(f"{progress_percent:.1f}%")
            progress_item.setTextAlignment(Qt.AlignCenter)
            self.timetable_table.setItem(i, 7, progress_item)
    
    def on_cell_clicked(self, row, column):
        """ì…€ í´ë¦­ ì‹œ ìˆ˜ì • ê°€ëŠ¥"""
        if not self.current_timetable or row >= len(self.current_timetable):
            return
        
        entry = self.current_timetable[row]
        
        if column in [2, 3]:  # ì˜¤ì „/ì˜¤í›„ ê³¼ëª© - ê³¼ëª© ë³€ê²½ (ì¸ë±ìŠ¤ +1)
            # ê³¼ëª© ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸
            dialog = SubjectSelectionDialog(self.subjects, entry['subject_code'], self)
            if dialog.exec_() == QDialog.Accepted:
                new_subject_code = dialog.get_selected_subject()
                if new_subject_code:
                    # ê³¼ëª© ì •ë³´ ì—…ë°ì´íŠ¸
                    new_subject = next((s for s in self.subjects if s['code'] == new_subject_code), None)
                    if new_subject:
                        entry['subject_code'] = new_subject_code
                        entry['subject_name'] = new_subject['name']
                        entry['subject_hours'] = new_subject['hours']
                        entry['main_instructor'] = new_subject.get('main_instructor_name') or '-'
                        entry['assistant_instructor'] = new_subject.get('assistant_instructor_name') or '-'
                        entry['reserve_instructor'] = new_subject.get('reserve_instructor_name') or '-'
                        
                        # í…Œì´ë¸” ì „ì²´ ë‹¤ì‹œ í‘œì‹œ (ì§„í–‰ë„ ì¬ê³„ì‚° í•„ìš”)
                        self.display_timetable(self.current_timetable)
        
        elif column == 4:  # ì£¼ê°•ì‚¬ í´ë¦­ - ì˜ˆë¹„ê°•ì‚¬ì™€ êµì²´ (ì¸ë±ìŠ¤ +1)
            if entry.get('reserve_instructor') and entry['reserve_instructor'] != '-':
                reply = QMessageBox.question(
                    self, "ê°•ì‚¬ êµì²´", 
                    f"ì£¼ê°•ì‚¬ì™€ ì˜ˆë¹„ê°•ì‚¬ë¥¼ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì£¼ê°•ì‚¬: {entry['main_instructor']}\nì˜ˆë¹„ê°•ì‚¬: {entry['reserve_instructor']}",
                    QMessageBox.Yes | QMessageBox.No
                )
                
                if reply == QMessageBox.Yes:
                    # ì£¼ê°•ì‚¬ â†” ì˜ˆë¹„ê°•ì‚¬ êµì²´
                    entry['main_instructor'], entry['reserve_instructor'] = \
                        entry['reserve_instructor'], entry['main_instructor']
                    
                    # í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ì¸ë±ìŠ¤ +1)
                    self.timetable_table.item(row, 4).setText(entry['main_instructor'])
                    self.timetable_table.item(row, 6).setText(entry['reserve_instructor'])
        
        elif column == 5:  # ë³´ì¡°ê°•ì‚¬ í´ë¦­ - ìˆ˜ì • (ì¸ë±ìŠ¤ +1)
            new_assistant, ok = QInputDialog.getText(
                self, "ë³´ì¡°ê°•ì‚¬ ìˆ˜ì •", 
                "ë³´ì¡°ê°•ì‚¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:",
                text=entry.get('assistant_instructor', '')
            )
            
            if ok:
                entry['assistant_instructor'] = new_assistant if new_assistant else '-'
                self.timetable_table.item(row, 5).setText(entry['assistant_instructor'])
        
        elif column == 6:  # ì˜ˆë¹„ê°•ì‚¬ í´ë¦­ - ì£¼ê°•ì‚¬ì™€ êµì²´ (ì¸ë±ìŠ¤ +1)
            if entry.get('main_instructor') and entry['main_instructor'] != '-':
                reply = QMessageBox.question(
                    self, "ê°•ì‚¬ êµì²´", 
                    f"ì˜ˆë¹„ê°•ì‚¬ì™€ ì£¼ê°•ì‚¬ë¥¼ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì˜ˆë¹„ê°•ì‚¬: {entry['reserve_instructor']}\nì£¼ê°•ì‚¬: {entry['main_instructor']}",
                    QMessageBox.Yes | QMessageBox.No
                )
                
                if reply == QMessageBox.Yes:
                    # ì˜ˆë¹„ê°•ì‚¬ â†” ì£¼ê°•ì‚¬ êµì²´
                    entry['reserve_instructor'], entry['main_instructor'] = \
                        entry['main_instructor'], entry['reserve_instructor']
                    
                    # í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ì¸ë±ìŠ¤ +1)
                    self.timetable_table.item(row, 4).setText(entry['main_instructor'])
                    self.timetable_table.item(row, 6).setText(entry['reserve_instructor'])
    
    def save_timetable(self):
        """ì‹œê°„í‘œ ì €ì¥"""
        if not self.current_timetable:
            QMessageBox.warning(self, "ê²½ê³ ", "ì €ì¥í•  ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.")
            return
        
        try:
            # ê¸°ì¡´ ì‹œê°„í‘œ ì‚­ì œ (ìˆë‹¤ë©´)
            delete_query = "DELETE FROM timetables WHERE course_code = %s AND type = 'lecture'"
            self.db.execute_query(delete_query, (self.selected_course,))
            
            # ìƒˆ ì‹œê°„í‘œ ì €ì¥
            insert_query = """
                INSERT INTO timetables 
                (course_code, subject_code, class_date, start_time, end_time, instructor_code, type)
                VALUES (%s, %s, %s, %s, %s, %s, 'lecture')
            """
            
            for entry in self.current_timetable:
                # ì£¼ê°•ì‚¬ ì½”ë“œ ì°¾ê¸°
                instructor_code = None
                main_instructor = entry.get('main_instructor', '-')
                if main_instructor and main_instructor != '-':
                    query = "SELECT code FROM instructors WHERE name = %s LIMIT 1"
                    result = self.db.fetch_one(query, (main_instructor,))
                    if result:
                        instructor_code = result['code']
                
                # ì˜¤ì „ ì‹œê°„í‘œ ì €ì¥
                self.db.execute_query(insert_query, (
                    self.selected_course,
                    entry['subject_code'],
                    entry['date'],
                    time(9, 0),
                    time(13, 0),
                    instructor_code
                ))
                
                # ì˜¤í›„ ì‹œê°„í‘œ ì €ì¥
                self.db.execute_query(insert_query, (
                    self.selected_course,
                    entry['subject_code'],
                    entry['date'],
                    time(14, 0),
                    time(18, 0),
                    instructor_code
                ))
            
            self.delete_btn.setEnabled(True)
            QMessageBox.information(self, "ì™„ë£Œ", "ì‹œê°„í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
            
        except Exception as e:
            QMessageBox.critical(self, "ì˜¤ë¥˜", f"ì‹œê°„í‘œ ì €ì¥ ì‹¤íŒ¨: {str(e)}")
    
    def export_excel(self):
        """Excel ë‚´ë³´ë‚´ê¸°"""
        if not self.current_timetable:
            QMessageBox.warning(self, "ê²½ê³ ", "ë‚´ë³´ë‚¼ ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.")
            return
        
        try:
            from openpyxl import Workbook
            from openpyxl.styles import Font, PatternFill, Alignment, Border, Side
            
            # íŒŒì¼ ì €ì¥ ê²½ë¡œ ì„ íƒ
            file_path, _ = QFileDialog.getSaveFileName(
                self, "ì‹œê°„í‘œ ì €ì¥", f"ì‹œê°„í‘œ_{self.selected_course}_{datetime.now().strftime('%Y%m%d')}.xlsx",
                "Excel Files (*.xlsx)"
            )
            
            if not file_path:
                return
            
            # ì›Œí¬ë¶ ìƒì„±
            wb = Workbook()
            ws = wb.active
            ws.title = "ì‹œê°„í‘œ"
            
            # í—¤ë” ì‘ì„±
            headers = ["ì£¼ì°¨", "ë‚ ì§œ", "ìš”ì¼", "ì˜¤ì „(09:00-13:00)", "ì˜¤í›„(14:00-18:00)", "ì£¼ê°•ì‚¬", "ë³´ì¡°ê°•ì‚¬", "ì˜ˆë¹„ê°•ì‚¬", "ì§„í–‰ë„"]
            ws.append(headers)
            
            # í—¤ë” ìŠ¤íƒ€ì¼
            header_fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
            header_font = Font(bold=True, color="FFFFFF")
            
            for cell in ws[1]:
                cell.fill = header_fill
                cell.font = header_font
                cell.alignment = Alignment(horizontal="center", vertical="center")
            
            # ê³¼ëª©ë³„ ëˆ„ì  ì‹œìˆ˜ ê³„ì‚°
            subject_accumulated = {}
            
            # ì‹œì‘ì¼ ê¸°ì¤€
            if self.current_timetable:
                start_date = self.current_timetable[0]['date']
            
            # ë°ì´í„° ì‘ì„±
            for entry in self.current_timetable:
                subject_code = entry['subject_code']
                
                # ëˆ„ì  ì‹œìˆ˜ ê³„ì‚°
                if subject_code not in subject_accumulated:
                    subject_accumulated[subject_code] = 0
                subject_accumulated[subject_code] += entry['hours']
                
                # ì£¼ì°¨ ê³„ì‚°
                current_date = entry['date']
                days_diff = (current_date - start_date).days
                week_number = (days_diff // 7) + 1
                
                date_str = entry['date'].strftime("%Y-%m-%d")
                weekday = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† ", "ì¼"][entry['date'].weekday()]
                
                subject_hours = entry.get('subject_hours', 0)
                progress_text = f"{entry['subject_name']} ({subject_accumulated[subject_code]}h/{subject_hours}h)"
                progress_percent = (subject_accumulated[subject_code] / subject_hours * 100) if subject_hours > 0 else 0
                
                row = [
                    f"{week_number}ì£¼ì°¨",
                    date_str,
                    weekday,
                    progress_text,
                    progress_text,
                    entry.get('main_instructor', '-'),
                    entry.get('assistant_instructor', '-'),
                    entry.get('reserve_instructor', '-'),
                    f"{progress_percent:.1f}%"
                ]
                ws.append(row)
                
                # ê³¼ëª© ìƒ‰ìƒ ì ìš© (ì»¬ëŸ¼ ì¸ë±ìŠ¤ +1)
                row_idx = ws.max_row
                color = self.subject_colors.get(entry['subject_code'])
                if color:
                    hex_color = "{:02X}{:02X}{:02X}".format(color.red(), color.green(), color.blue())
                    fill = PatternFill(start_color=hex_color, end_color=hex_color, fill_type="solid")
                    ws.cell(row_idx, 4).fill = fill
                    ws.cell(row_idx, 5).fill = fill
            
            # ì—´ ë„ˆë¹„ ì¡°ì •
            ws.column_dimensions['A'].width = 10  # ì£¼ì°¨
            ws.column_dimensions['B'].width = 15  # ë‚ ì§œ
            ws.column_dimensions['C'].width = 8   # ìš”ì¼
            ws.column_dimensions['D'].width = 35  # ì˜¤ì „
            ws.column_dimensions['E'].width = 35  # ì˜¤í›„
            ws.column_dimensions['F'].width = 12  # ì£¼ê°•ì‚¬
            ws.column_dimensions['G'].width = 12  # ë³´ì¡°ê°•ì‚¬
            ws.column_dimensions['H'].width = 12  # ì˜ˆë¹„ê°•ì‚¬
            ws.column_dimensions['I'].width = 10  # ì§„í–‰ë„
            
            # í…Œë‘ë¦¬ ìŠ¤íƒ€ì¼
            border = Border(
                left=Side(style='thin'),
                right=Side(style='thin'),
                top=Side(style='thin'),
                bottom=Side(style='thin')
            )
            
            for row in ws.iter_rows(min_row=1, max_row=ws.max_row, min_col=1, max_col=9):
                for cell in row:
                    cell.border = border
                    cell.alignment = Alignment(horizontal="center", vertical="center")
            
            # íŒŒì¼ ì €ì¥
            wb.save(file_path)
            QMessageBox.information(self, "ì™„ë£Œ", f"ì‹œê°„í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n{file_path}")
            
        except ImportError:
            QMessageBox.critical(self, "ì˜¤ë¥˜", "openpyxl ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.\npip install openpyxl")
        except Exception as e:
            QMessageBox.critical(self, "ì˜¤ë¥˜", f"Excel ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: {str(e)}")
    
    def import_excel(self):
        """Excel ê°€ì ¸ì˜¤ê¸°"""
        try:
            from openpyxl import load_workbook
            
            # íŒŒì¼ ì„ íƒ
            file_path, _ = QFileDialog.getOpenFileName(
                self, "ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê¸°", "", "Excel Files (*.xlsx)"
            )
            
            if not file_path:
                return
            
            # Excel íŒŒì¼ ì½ê¸°
            wb = load_workbook(file_path)
            ws = wb.active
            
            # ë°ì´í„° íŒŒì‹±
            self.current_timetable = []
            
            for row_idx, row in enumerate(ws.iter_rows(min_row=2, values_only=True), start=2):
                if not row[0]:  # ë‚ ì§œê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
                    continue
                
                date_str = str(row[0])
                subject_name = row[2]  # ì˜¤ì „ ê³¼ëª©
                instructor_name = row[4] if len(row) > 4 else '-'
                
                # ë‚ ì§œ íŒŒì‹±
                try:
                    if isinstance(row[0], datetime):
                        class_date = row[0].date()
                    else:
                        class_date = datetime.strptime(date_str, "%Y-%m-%d").date()
                except:
                    continue
                
                # ê³¼ëª© ì°¾ê¸°
                subject = next((s for s in self.subjects if s['name'] == subject_name), None)
                if subject:
                    self.current_timetable.append({
                        'date': class_date,
                        'subject_code': subject['code'],
                        'subject_name': subject['name'],
                        'instructor': instructor_name,
                        'hours': 8
                    })
            
            # í…Œì´ë¸”ì— í‘œì‹œ
            self.display_timetable(self.current_timetable)
            self.save_btn.setEnabled(True)
            self.export_btn.setEnabled(True)
            
            QMessageBox.information(self, "ì™„ë£Œ", f"{len(self.current_timetable)}ê°œì˜ ì‹œê°„í‘œ í•­ëª©ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.")
            
        except ImportError:
            QMessageBox.critical(self, "ì˜¤ë¥˜", "openpyxl ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.\npip install openpyxl")
        except Exception as e:
            QMessageBox.critical(self, "ì˜¤ë¥˜", f"Excel ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: {str(e)}")
    
    def delete_timetable(self):
        """ì‹œê°„í‘œ ì‚­ì œ"""
        reply = QMessageBox.question(
            self, "í™•ì¸", "í˜„ì¬ ê³¼ì •ì˜ ì‹œê°„í‘œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
            QMessageBox.Yes | QMessageBox.No
        )
        
        if reply == QMessageBox.Yes:
            try:
                delete_query = "DELETE FROM timetables WHERE course_code = %s AND type = 'lecture'"
                self.db.execute_query(delete_query, (self.selected_course,))
                
                # í…Œì´ë¸” ì´ˆê¸°í™”
                self.timetable_table.setRowCount(0)
                self.current_timetable = []
                self.save_btn.setEnabled(False)
                self.export_btn.setEnabled(False)
                self.delete_btn.setEnabled(False)
                
                QMessageBox.information(self, "ì™„ë£Œ", "ì‹œê°„í‘œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
                
            except Exception as e:
                QMessageBox.critical(self, "ì˜¤ë¥˜", f"ì‹œê°„í‘œ ì‚­ì œ ì‹¤íŒ¨: {str(e)}")


class SubjectSelectionDialog(QDialog):
    """ê³¼ëª© ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸"""
    
    def __init__(self, subjects, current_subject_code, parent=None):
        super().__init__(parent)
        self.subjects = subjects
        self.current_subject_code = current_subject_code
        self.selected_subject_code = None
        self.init_ui()
    
    def init_ui(self):
        """UI ì´ˆê¸°í™”"""
        self.setWindowTitle("ê³¼ëª© ë³€ê²½")
        self.setMinimumWidth(400)
        
        layout = QVBoxLayout()
        
        # ì•ˆë‚´ ë©”ì‹œì§€
        label = QLabel("ë³€ê²½í•  ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”:")
        label.setStyleSheet("font-size: 11pt; font-weight: bold;")
        layout.addWidget(label)
        
        # ê³¼ëª© ì½¤ë³´ë°•ìŠ¤
        self.subject_combo = QComboBox()
        self.subject_combo.setStyleSheet("font-size: 11pt;")
        self.subject_combo.setMinimumHeight(32)
        
        for subject in self.subjects:
            self.subject_combo.addItem(
                f"{subject['name']} ({subject['hours']}ì‹œê°„)",
                subject['code']
            )
            if subject['code'] == self.current_subject_code:
                self.subject_combo.setCurrentIndex(self.subject_combo.count() - 1)
        
        layout.addWidget(self.subject_combo)
        
        # ë²„íŠ¼
        button_box = QDialogButtonBox(
            QDialogButtonBox.Ok | QDialogButtonBox.Cancel
        )
        button_box.accepted.connect(self.accept)
        button_box.rejected.connect(self.reject)
        layout.addWidget(button_box)
        
        self.setLayout(layout)
    
    def accept(self):
        """í™•ì¸ ë²„íŠ¼"""
        self.selected_subject_code = self.subject_combo.currentData()
        super().accept()
    
    def get_selected_subject(self):
        """ì„ íƒëœ ê³¼ëª© ì½”ë“œ ë°˜í™˜"""
        return self.selected_subject_code
